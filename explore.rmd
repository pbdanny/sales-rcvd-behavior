# Initialise Project
```{r adjust_directory_if_needed}
# Uncomment lines below if rmd file is placed in a subdirectory
# library(knitr)
# opts_knit$set(root.dir = normalizePath('../')) 
```

```{r load_project, echo = FALSE, message = FALSE}
# 1. Set options in config/global.dcf
# 2. Load packages listed in config/global.dcf
# 3. Import functions and coe in lib directory
# 4. Load data in data directory
# 5. Run data manipulations in munge directory 

rm(list = ls()) # optionally refresh workspaces
library(ProjectTemplate); load.project()
```             

# Explore
## Rcvd by week of year, colored by month
```{r rcvd by week of year, echo = FALSE}
library(plotly)

g <- ggplot(data = oss_rcvd,
       aes(x = no_week_of_year, fill = as.factor(month))) +
    geom_histogram(stat = "count")
ggplotly(g)
```

## Rcvd by week of year, colored by month
```{r rcvd by source code, echo = FALSE}
g <- ggplot(data = subset(oss_rcvd),
            aes(x = no_week_of_year, fill = as.factor(source_code))) +
    geom_histogram(stat = "count", position = "stack")
ggplotly(g)
```

## Recency by week, number of last submit week and number of the week before last submit (current week = 51)
```{r recency by week, echo = FALSE}
# use split, apply and combine to create dataframe of recency
rcvd_list <- split(oss_rcvd, oss_rcvd$agent_code)
recency_list <- lapply(rcvd_list, FUN = findRecency)
recency <- do.call(rbind, recency_list)
recency$agent_code <- as.integer(rownames(recency))
rownames(recency) <- NULL
# clear temp varibles
rm(list = c("rcvd_list", "recency_list"))
```

## Some EDA on recency
```{r recency EDA, echo = FALSE}
ggplot(data = recency,
       aes(x = diff_last)) +
    geom_histogram(breaks = seq(1, 50, 1))

ggplot(data = recency,
       aes(x = diff_lag1)) +
    geom_histogram(breaks = seq(1, 50, 1))
```

## Summary by day of week (Mon = 1 .. Sun = 7)
## Summary by weekly 
```{r summary by week, echo = FALSE}
# Pre summarise dataframe
summary_by_week <- oss_rcvd %>%
    dplyr::select(-date) %>%  # exclude data since problems group_by
    group_by(agent_code, no_week_of_year, day_of_week) %>%
    summarise(submit = n())
# rcvd by day by week
rcvd_day_of_week <- summary_by_week %>%
    group_by(agent_code, day_of_week) %>%
    summarise(avg_time_by_day_of_week = n(),
              avg_submit_by_day_of_week = mean(submit))

# spread from long to wide format
# time submit by day of week
time_day_of_week <- rcvd_day_of_week %>%
    mutate(key_column_name = paste0(day_of_week, "_time")) %>%
    select(-avg_submit_by_day_of_week, -day_of_week) %>%
    spread(key = key_column_name, value = avg_time_by_day_of_week,
           fill = 0)  # fill 0 if no data

# avg submit by day of week
avg_submit_day_of_week <- rcvd_day_of_week %>%
    mutate(key_column_name = paste0(day_of_week, "_submit")) %>%
    select(-avg_time_by_day_of_week, -day_of_week) %>%
    spread(key = key_column_name, value = avg_submit_by_day_of_week,
           fill = 0)  # fill 0 if no data

# rcvd by weekly
rcvd_by_week <- summary_by_week %>%
    group_by(agent_code, no_week_of_year) %>%
    summarise(time_by_week = n(), 
              submit_by_week = sum(submit)) %>%
    group_by(agent_code) %>%
    summarise(avg_time_by_week = mean(time_by_week),
              avg_submit_by_week = mean(submit_by_week))

rm(list = c("summary_by_week","rcvd_day_of_week"))
```

## EDA on time, submit by day of week and by week

```{r eda time and submit, echo = FALSE}
time_day_of_week %>%
    gather(day_of_week, time, Fri_time:Wed_time) %>%
    filter(time > 0) %>%
    mutate(day_of_week_f = factor(day_of_week, levels = 
            c("Mon_time", "Tue_time", "Wed_time", "Thu_time", "Fri_time", "Sat_time"))) %>%
    ggplot(aes(x = time, color = day_of_week_f)) +
    geom_freqpoly(binwidth = 1) +
    ggtitle(label = "Number of agent submit by time in each day of week") + 
    scale_x_continuous(breaks = seq(1, 10, 1), labels = seq(1, 10, 1), limits = c(1, 20)) +
    ggsave(filename = "eda_1.jpeg", path = "./reports")
    
avg_submit_day_of_week %>%
    gather(day_of_week, submit, Fri_submit:Wed_submit) %>%
    filter(submit > 0) %>%
    mutate(day_of_week_f = factor(day_of_week, levels = 
            c("Mon_submit", "Tue_submit", "Wed_submit", "Thu_submit", "Fri_submit", "Sat_submit"))) %>%
    ggplot(aes(x = submit, fill = day_of_week_f)) +
    geom_histogram() +
    facet_grid(. ~ day_of_week_f) +
    ggtitle(label = "Nubmer of agent submit by number app. in each day of week") + 
    ggsave(file = "eda_2.jpeg", path = "./reports")
```

## product, bundle preference

```{r product & bundle, echo = FALSE}
prod_bundle_per <- oss_rcvd %>%
    dplyr::select(-date) %>%
    group_by(agent_code) %>%
    summarise(tt_cc = sum(product == "CC"),
              tt_pl = sum(product == "REV"),
              tt_submit = n(),
              tt_bundle = sum(bundle == "Y"),
              per_cc = tt_cc/n(),
              per_bundle = tt_bundle/n())
```


## EDA on Contribution by Products / Bundle
```{r eda product and bundle, echo = FALSE}
prod_bundle_per %>%
    filter(tt_cc > 0, tt_pl > 0) %>%
    ggplot(aes(x = per_cc)) +
    geom_histogram() +
    ggtitle("Number of agent by Percent submit Credit Card / Total") +
    ggsave(file = "eda_3.jpeg", path = "./reports")

prod_bundle_per %>%
    filter(tt_cc > 0, tt_pl > 0) %>%
    ggplot(aes(x = per_bundle)) +
    geom_histogram() +
    ggtitle("Number of agent by Percent submit Bundle / Total") +
    ggsave(file = "eda_4.jpeg", path = "./reports")

```

## combine all featues
```{r combine features, echo = FALSE}
d <- avg_submit_day_of_week %>%
    left_join(time_day_of_week) %>%
    left_join(recency) %>%
    left_join(rcvd_by_week) %>%
    left_join(prod_bundle_per)

df <- as.data.frame(d)
df$agent_code <- as.character(df$agent_code)
rm(list = c("d","avg_submit_day_of_week", "prod_bundle_per", "rcvd_by_week", "recency", "time_day_of_week"))
```

# Clustering
## Hierarchical
```{r hierarchical, echo = FALSE}
# normalization
rownames(df) <- df$agent_code
df$agent_code <- NULL
df_norm <- as.data.frame(scale(df))

# distance calculation
dist <- dist(df_norm, method = "euclidean")

# hierarchical clustering
clust <- hclust(dist, method = "ward.D")

# create clustering group by cutting tree
# repeating choose cluster group 3, 4, 5
clust_group <- cutree(clust, k = 5)
table(clust_group)

# map back data and cluster for recheck clustering efficiency
rcvd_clust <- cbind(df, clust_group)
```

## EDA clustering efficiency
```{r cluster efficiency, echo = FALSE}
clust_sum <- sapply(split(rcvd_clust, rcvd_clust$clust_gropu), colMeans)
View(clust_sum)

rcvd_clust %>%
    ggplot(aes(y = per_bundle, x = clust_group, group = clust_group)) +
    geom_boxplot()
# group '4' rarely bundle

rcvd_clust %>%
    ggplot(aes(y = Tue_time, x = clust_group, group = clust_group)) +
    geom_boxplot()
# group '2' in consistant submit

rcvd_clust %>%
    ggplot(aes(y = Mon_submit, x = clust_group, group = clust_group)) +
    geom_boxplot()
# group '5' high performance

rcvd_clust %>%
    ggplot(aes(y = diff_last, x = clust_group, group = clust_group)) +
    geom_boxplot()
# group '1' dormant

rcvd_clust %>%
    ggplot(aes(y = avg_time_by_week, x = clust_group, group = clust_group)) +
    geom_boxplot()
# group '3' loyal not productive
```

## Mapping agent cluster with advisor performance group
```{r mapping cluster with advisor, echo = FALSE}
sales_clust <- data.frame("agent_code" = names(clust_group),
                          "clust" = clust_group)
row.names(sales_clust) <- NULL
sales_clust_advisor_group <- merge(sales, sales_clust, by = "agent_code", 
                                   all.x = TRUE)
sales_clust_advisor_group <- merge(sales_clust_advisor_group, advisor_group, 
                                   by = "amsup", all.x = TRUE)
# check count by group
table(sales_clust$clust)
table(sales_clust_advisor_group$clust)
```

